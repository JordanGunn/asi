{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "step_output_v1.schema.json",
  "title": "Plan Step Output Contract",
  "description": "Schema for per-step reasoning outputs during asi-plan",
  "type": "object",
  "required": ["step", "output"],
  "properties": {
    "step": {
      "type": "integer",
      "minimum": 2,
      "maximum": 8,
      "description": "Step number being completed (1 is automated)"
    },
    "output": {
      "type": "object",
      "description": "Step-specific output"
    },
    "reasoning_trace": {
      "type": "string",
      "description": "Brief explanation of reasoning for audit"
    }
  },
  "$defs": {
    "step2_scripts": {
      "type": "object",
      "required": ["scripts"],
      "properties": {
        "scripts": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "purpose"],
            "properties": {
              "name": { "type": "string" },
              "purpose": { "type": "string" },
              "inputs": { "type": "string" },
              "outputs": { "type": "string" }
            }
          },
          "description": "Scripts to create from deterministic surface"
        }
      }
    },
    "step3_assets": {
      "type": "object",
      "required": ["schemas", "templates"],
      "properties": {
        "schemas": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "purpose"],
            "properties": {
              "name": { "type": "string" },
              "purpose": { "type": "string" }
            }
          },
          "description": "Schema files to create"
        },
        "templates": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "purpose"],
            "properties": {
              "name": { "type": "string" },
              "purpose": { "type": "string" }
            }
          },
          "description": "Template files to create"
        }
      }
    },
    "step4_validation": {
      "type": "object",
      "required": ["validations"],
      "properties": {
        "validations": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["mechanism", "validates", "failure_behavior"],
            "properties": {
              "mechanism": { "type": "string" },
              "validates": { "type": "string" },
              "failure_behavior": { "type": "string" }
            }
          },
          "description": "Validation mechanisms"
        }
      }
    },
    "step5_boundaries": {
      "type": "object",
      "required": ["in_scope", "out_of_scope"],
      "properties": {
        "in_scope": {
          "type": "array",
          "items": { "type": "string" },
          "description": "What this implementation includes"
        },
        "out_of_scope": {
          "type": "array",
          "items": { "type": "string" },
          "description": "What this implementation excludes"
        }
      }
    },
    "step6_risks": {
      "type": "object",
      "required": ["risks"],
      "properties": {
        "risks": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["risk", "severity", "mitigation"],
            "properties": {
              "risk": { "type": "string" },
              "severity": {
                "type": "string",
                "enum": ["low", "medium", "high", "critical"]
              },
              "mitigation": { "type": "string" }
            }
          },
          "description": "Risks from judgment remainder"
        }
      }
    },
    "step7_lifecycle": {
      "type": "object",
      "required": ["artifacts", "status_flow", "human_gates"],
      "properties": {
        "artifacts": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Artifacts this skill produces"
        },
        "status_flow": {
          "type": "string",
          "description": "Status transitions"
        },
        "human_gates": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Where human approval is required"
        }
      }
    },
    "step8_tasks": {
      "type": "object",
      "required": ["tasks"],
      "properties": {
        "tasks": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "description", "source_section"],
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^T[0-9]{3}$"
              },
              "description": { "type": "string" },
              "status": {
                "type": "string",
                "enum": ["pending", "in_progress", "done"],
                "default": "pending"
              },
              "depends_on": { "type": "string" },
              "source_section": { "type": "string" }
            }
          },
          "description": "Finalized task list with traceability"
        }
      }
    }
  }
}
